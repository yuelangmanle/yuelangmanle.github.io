<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡æ–‡è€å¸ˆä¸“å±å›¾ç‰‡å¤„ç†å·¥å…·</title>
    <style>
        :root {
            --primary: #9c27b0;
            --secondary: #7e57c2;
            --accent: #ff9800;
            --dark: #4527a0;
            --light: #f3e5f5;
            --warning: #e74c3c;
            --success: #2ecc71;
            --shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #7b1fa2 0%, #4527a0 100%);
            color: #333;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            padding: 30px 0;
            color: white;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
            background: rgba(0,0,0,0.2);
            border-radius: 15px;
        }
        
        .header-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, rgba(156, 39, 176, 0.2), rgba(126, 87, 194, 0.3));
            z-index: 0;
        }
        
        .header-content {
            position: relative;
            z-index: 2;
        }
        
        h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            color: #fff;
        }
        
        .subtitle {
            font-size: 1.3rem;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto;
            color: #ffeb3b;
            font-weight: 500;
        }
        
        .brand {
            font-size: 1.8rem;
            color: var(--accent);
            margin-top: 10px;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(255, 152, 0, 0.5);
        }
        
        .card-container {
            display: flex;
            flex-wrap: wrap;
            gap: 25px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            box-shadow: var(--shadow);
            overflow: hidden;
            width: 100%;
            max-width: 550px;
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            background: var(--dark);
            color: white;
            padding: 15px 20px;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .card-body {
            padding: 25px;
        }
        
        .upload-area {
            border: 3px dashed var(--primary);
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            background-color: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 25px;
        }
        
        .upload-area:hover {
            background-color: #f3e5f5;
            border-color: #7b1fa2;
        }
        
        .upload-icon {
            font-size: 60px;
            color: var(--primary);
            margin-bottom: 15px;
        }
        
        .file-input {
            display: none;
        }
        
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-block;
            margin: 10px 5px;
            box-shadow: 0 4px 6px rgba(50, 50, 93, 0.11), 0 1px 3px rgba(0, 0, 0, 0.08);
        }
        
        .btn:hover {
            background: #7b1fa2;
            transform: translateY(-2px);
            box-shadow: 0 7px 14px rgba(50, 50, 93, 0.1), 0 3px 6px rgba(0, 0, 0, 0.08);
        }
        
        .btn:active {
            transform: translateY(1px);
        }
        
        .btn-compress {
            background: var(--secondary);
        }
        
        .btn-compress:hover {
            background: #5e35b1;
        }
        
        .btn-accent {
            background: var(--accent);
            color: #333;
        }
        
        .btn-accent:hover {
            background: #ef6c00;
            color: white;
        }
        
        .btn-success {
            background: var(--success);
        }
        
        .btn-success:hover {
            background: #27ae60;
        }
        
        .btn-warning {
            background: var(--warning);
        }
        
        .btn-warning:hover {
            background: #c0392b;
        }
        
        .result-container {
            display: none;
            margin-top: 30px;
        }
        
        .image-preview {
            max-width: 100%;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin: 20px 0;
            max-height: 300px;
        }
        
        .info {
            background: #f3e5f5;
            border-left: 4px solid var(--primary);
            padding: 15px;
            border-radius: 0 8px 8px 0;
            margin: 20px 0;
            text-align: left;
        }
        
        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 25px 0;
        }
        
        .feature {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            text-align: center;
            transition: all 0.3s;
        }
        
        .feature:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .feature-icon {
            font-size: 2.5rem;
            color: var(--primary);
            margin-bottom: 15px;
        }
        
        footer {
            text-align: center;
            color: white;
            padding: 30px 0;
            margin-top: 40px;
            font-size: 0.9rem;
            opacity: 0.8;
            position: relative;
        }
        
        .signature {
            font-size: 1.1rem;
            color: var(--accent);
            font-weight: bold;
            margin-top: 10px;
        }
        
        /* æ‰¹é‡å¤„ç†æ ·å¼ */
        .batch-section {
            margin-top: 30px;
            display: none;
        }
        
        .batch-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .batch-controls button {
            flex: 1;
            min-width: 150px;
        }
        
        .file-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .file-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .file-item:last-child {
            border-bottom: none;
        }
        
        .file-icon {
            font-size: 24px;
            margin-right: 15px;
            color: var(--primary);
        }
        
        .file-info {
            flex: 1;
        }
        
        .file-name {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .file-size {
            font-size: 0.85rem;
            color: #666;
        }
        
        .rename-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .rename-section {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .progress-container {
            margin-top: 20px;
        }
        
        .progress-bar {
            height: 10px;
            background-color: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .download-all {
            text-align: center;
            margin-top: 20px;
            display: none;
        }
        
        .excel-section {
            background: #f3e5f5;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .excel-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            background: white;
        }
        
        .excel-table th, .excel-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        
        .excel-table th {
            background-color: #f2f2f2;
        }
        
        .size-indicator {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            margin-left: 8px;
            font-weight: bold;
        }
        
        .size-ok {
            background-color: #d4edda;
            color: #155724;
        }
        
        .size-warning {
            background-color: #fff3cd;
            color: #856404;
        }
        
        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        .special-tag {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--accent);
            color: white;
            padding: 5px 15px;
            border-radius: 30px;
            font-weight: bold;
            transform: rotate(5deg);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        
        .powered-by {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        .compression-stats {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            font-weight: bold;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.5rem;
            color: var(--primary);
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }
        
        .success-message {
            display: none;
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-bg"></div>
            <div class="header-content">
                <h1>æ–‡æ–‡è€å¸ˆä¸“å±å›¾ç‰‡å¤„ç†å·¥å…·</h1>
                <p class="subtitle">ä¸“ä¸šçº§å›¾ç‰‡å‹ç¼© + Excelé‡å‘½ååŠŸèƒ½</p>
                <div class="brand">100KBä»¥ä¸‹å‹ç¼©ä¿è¯ Â· æ‰¹é‡æ‰“åŒ…ä¸‹è½½</div>
                <div class="special-tag">by é‚“æ¢“æ°</div>
            </div>
        </header>

        <div class="card-container">
            <div class="card">
                <div class="card-header">
                    <span>æ‰¹é‡å›¾ç‰‡å¤„ç†</span>
                    <span id="fileCount">0 ä¸ªæ–‡ä»¶</span>
                </div>
                <div class="card-body">
                    <div class="upload-area" id="dropArea">
                        <div class="upload-icon">ğŸ“</div>
                        <h3>æ‹–æ”¾å›¾ç‰‡åˆ°æ­¤å¤„æˆ–ç‚¹å‡»ä¸Šä¼ </h3>
                        <p>æ”¯æŒæ‰¹é‡ä¸Šä¼  JPG, PNG, GIF, WebP æ ¼å¼å›¾ç‰‡</p>
                        <input type="file" id="fileInput" class="file-input" accept="image/*" multiple>
                        <button class="btn btn-accent pulse" onclick="document.getElementById('fileInput').click()">é€‰æ‹©å›¾ç‰‡</button>
                    </div>
                    
                    <div class="info">
                        <p><strong>ä¸“ä¸šå‹ç¼©ä¿è¯ï¼š</strong></p>
                        <p>âœ… æ‰€æœ‰å›¾ç‰‡ä¿è¯å‹ç¼©è‡³100KBä»¥ä¸‹</p>
                        <p>âœ… è¶…å¤§å›¾ç‰‡æ™ºèƒ½å°ºå¯¸ç¼©å‡æŠ€æœ¯</p>
                        <p>âœ… ä¿ç•™æœ€ä½³è§†è§‰è´¨é‡</p>
                        <p>âœ… ä¸€é”®æ‰“åŒ…ä¸‹è½½æ‰€æœ‰å›¾ç‰‡</p>
                    </div>
                    
                    <div class="batch-section" id="batchSection">
                        <div class="batch-controls">
                            <button class="btn btn-compress" onclick="compressBatch()">æ‰¹é‡å‹ç¼©å›¾ç‰‡</button>
                            <button class="btn" onclick="downloadExcelTemplate()">ä¸‹è½½é‡å‘½åæ¨¡æ¿</button>
                            <button class="btn" onclick="document.getElementById('excelInput').click()">å¯¼å…¥Excelé‡å‘½å</button>
                            <input type="file" id="excelInput" class="file-input" accept=".xlsx,.xls" style="display: none;">
                        </div>
                        
                        <div class="file-list" id="fileList">
                            <!-- æ–‡ä»¶åˆ—è¡¨ä¼šåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                        
                        <div class="progress-container">
                            <p>å¤„ç†è¿›åº¦: <span id="progressText">0%</span></p>
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill"></div>
                            </div>
                        </div>
                        
                        <div class="compression-stats">
                            <div class="stat-item">
                                <div class="stat-value" id="originalTotal">0 KB</div>
                                <div class="stat-label">åŸå§‹å¤§å°</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="compressedTotal">0 KB</div>
                                <div class="stat-label">å‹ç¼©åå¤§å°</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="savings">0%</div>
                                <div class="stat-label">èŠ‚çœç©ºé—´</div>
                            </div>
                        </div>
                        
                        <div class="success-message" id="successMessage">
                            âœ… æ‰€æœ‰å›¾ç‰‡å¤„ç†å®Œæˆï¼å‡†å¤‡ä¸‹è½½
                        </div>
                        
                        <div class="download-all" id="downloadAll">
                            <button class="btn btn-success" onclick="downloadAllAsZip()">æ‰“åŒ…ä¸‹è½½æ‰€æœ‰å›¾ç‰‡</button>
                            <p style="margin-top: 15px; color: #666;">ä¸‹è½½åŒ…å«æ‰€æœ‰å‹ç¼©å›¾ç‰‡çš„ZIPå‹ç¼©åŒ…</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <span>é«˜çº§åŠŸèƒ½ä¸è¯´æ˜</span>
                    <span>âš™ï¸</span>
                </div>
                <div class="card-body">
                    <div class="excel-section">
                        <h3>Excelé‡å‘½ååŠŸèƒ½</h3>
                        <p>1. ç‚¹å‡»"ä¸‹è½½é‡å‘½åæ¨¡æ¿"æŒ‰é’®è·å–Excelæ¨¡æ¿</p>
                        <p>2. åœ¨Excelä¸­å¡«å†™æ–°æ–‡ä»¶åï¼ˆä¸éœ€è¦æ‰©å±•åï¼‰</p>
                        <p>3. ç‚¹å‡»"å¯¼å…¥Excelé‡å‘½å"å¯¼å…¥æ–‡ä»¶</p>
                        <p>4. ç³»ç»Ÿå°†è‡ªåŠ¨åº”ç”¨æ–°çš„æ–‡ä»¶å</p>
                        
                        <table class="excel-table">
                            <thead>
                                <tr>
                                    <th>åŸå§‹æ–‡ä»¶å</th>
                                    <th>æ–°æ–‡ä»¶å</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>IMG_001.jpg</td>
                                    <td>äº§å“å±•ç¤º-1</td>
                                </tr>
                                <tr>
                                    <td>IMG_002.png</td>
                                    <td>äº§å“å±•ç¤º-2</td>
                                </tr>
                                <tr>
                                    <td>photo123.jpeg</td>
                                    <td>å…¬å¸æ´»åŠ¨</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="info">
                        <p><strong>å‹ç¼©æŠ€æœ¯è¯´æ˜ï¼š</strong></p>
                        <p>1. é‡‡ç”¨æ™ºèƒ½å‹ç¼©ç®—æ³•ï¼Œä¿è¯æ‰€æœ‰å›¾ç‰‡å‹ç¼©åˆ°100KBä»¥ä¸‹</p>
                        <p>2. å¯¹äºå¤§å°ºå¯¸å›¾ç‰‡ï¼Œè‡ªåŠ¨è°ƒæ•´å°ºå¯¸å’Œè´¨é‡</p>
                        <p>3. ä¸“ä¸šçº§è§†è§‰è´¨é‡ä¿ç•™æŠ€æœ¯</p>
                        <p>4. æ‰€æœ‰å¤„ç†åœ¨æµè§ˆå™¨ä¸­å®Œæˆï¼Œä¸ä¸Šä¼ æœåŠ¡å™¨</p>
                    </div>
                    
                    <div class="features">
                        <div class="feature">
                            <div class="feature-icon">ğŸ’¯</div>
                            <h3>100KBä¿è¯</h3>
                            <p>æ‰€æœ‰å›¾ç‰‡å‹ç¼©è¾¾æ ‡</p>
                        </div>
                        <div class="feature">
                            <div class="feature-icon">ğŸ“¦</div>
                            <h3>æ‰“åŒ…ä¸‹è½½</h3>
                            <p>ä¸€é”®ä¸‹è½½æ‰€æœ‰å›¾ç‰‡</p>
                        </div>
                        <div class="feature">
                            <div class="feature-icon">ğŸ”’</div>
                            <h3>éšç§ä¿æŠ¤</h3>
                            <p>æœ¬åœ°å¤„ç†ä¸ä¸Šä¼ </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <p>Â© 2025 æ–‡æ–‡è€å¸ˆä¸“å±å›¾ç‰‡å¤„ç†å·¥å…· | ä¸“ä¸šçº§å›¾ç‰‡å‹ç¼©è§£å†³æ–¹æ¡ˆ</p>
        <div class="signature">å®šåˆ¶å¼€å‘ï¼šé‚“æ¢“æ° | æŠ€æœ¯æ”¯æŒï¼š3335196397@qq.com</div>
        <div class="powered-by">
            <span>æŠ€æœ¯æ”¯æŒï¼šHTML5 Canvas Â· JavaScript Â· SheetJS Â· JSZip</span>
        </div>
    </footer>

    <!-- å¼•å…¥SheetJSåº“ç”¨äºå¤„ç†Excelæ–‡ä»¶ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- å¼•å…¥JSZipåº“ç”¨äºæ‰“åŒ…ä¸‹è½½ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        // å­˜å‚¨æ‰€æœ‰æ–‡ä»¶æ•°æ®
        let files = [];
        let compressedFiles = [];
        const maxSizeKB = 100; // æœ€å¤§100KB
        let totalOriginalSize = 0;
        let totalCompressedSize = 0;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // è®¾ç½®æ–‡ä»¶è¾“å…¥äº‹ä»¶
            document.getElementById('fileInput').addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleFiles(e.target.files);
                }
            });

            // è®¾ç½®Excelå¯¼å…¥äº‹ä»¶
            document.getElementById('excelInput').addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleExcelFile(e.target.files[0]);
                }
            });

            // è®¾ç½®æ‹–æ”¾åŒºåŸŸäº‹ä»¶
            const dropArea = document.getElementById('dropArea');
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, unhighlight, false);
            });

            function highlight() {
                dropArea.style.backgroundColor = '#f3e5f5';
                dropArea.style.borderColor = '#7b1fa2';
            }

            function unhighlight() {
                dropArea.style.backgroundColor = '#f8f9fa';
                dropArea.style.borderColor = '#9c27b0';
            }

            dropArea.addEventListener('drop', handleDrop, false);

            function handleDrop(e) {
                const dt = e.dataTransfer;
                handleFiles(dt.files);
            }
        });

        // å¤„ç†å¤šä¸ªæ–‡ä»¶
        function handleFiles(fileList) {
            files = [];
            compressedFiles = [];
            totalOriginalSize = 0;
            totalCompressedSize = 0;
            
            // è¿‡æ»¤éå›¾ç‰‡æ–‡ä»¶
            for (let i = 0; i < fileList.length; i++) {
                const file = fileList[i];
                if (file.type.match('image.*')) {
                    totalOriginalSize += file.size;
                    files.push({
                        file: file,
                        name: file.name,
                        compressed: false,
                        newName: file.name.replace(/\.[^/.]+$/, "") // ç§»é™¤æ‰©å±•å
                    });
                }
            }
            
            if (files.length === 0) {
                alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ï¼');
                return;
            }
            
            // æ›´æ–°æ–‡ä»¶è®¡æ•°
            document.getElementById('fileCount').textContent = files.length + ' ä¸ªæ–‡ä»¶';
            updateSizeStats();
            
            // æ˜¾ç¤ºæ‰¹é‡å¤„ç†åŒºåŸŸ
            document.getElementById('batchSection').style.display = 'block';
            document.getElementById('downloadAll').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
            
            // ç”Ÿæˆæ–‡ä»¶åˆ—è¡¨
            renderFileList();
        }

        // æ¸²æŸ“æ–‡ä»¶åˆ—è¡¨
        function renderFileList() {
            const fileListEl = document.getElementById('fileList');
            fileListEl.innerHTML = '';
            
            files.forEach((fileData, index) => {
                const file = fileData.file;
                const fileSizeKB = (file.size / 1024).toFixed(2);
                const fileType = file.name.split('.').pop().toUpperCase();
                
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div class="file-icon">ğŸ“·</div>
                    <div class="file-info">
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">${fileSizeKB} KB | ${fileType}</div>
                        <div class="rename-section">
                            <input type="text" class="rename-input" 
                                value="${fileData.newName}" 
                                data-index="${index}"
                                placeholder="è¾“å…¥æ–°æ–‡ä»¶å">
                            <button class="btn" onclick="updateFileName(${index})">åº”ç”¨</button>
                        </div>
                    </div>
                    <div class="file-status">${fileData.compressed ? '<span class="size-indicator size-ok">âœ“ å·²å‹ç¼©</span>' : '<span class="size-indicator size-warning">å¾…å¤„ç†</span>'}</div>
                `;
                
                fileListEl.appendChild(fileItem);
            });
        }

        // æ›´æ–°æ–‡ä»¶å
        function updateFileName(index) {
            const input = document.querySelector(`.rename-input[data-index="${index}"]`);
            if (input) {
                files[index].newName = input.value;
                alert(`æ–‡ä»¶åå·²æ›´æ–°: ${files[index].name} -> ${files[index].newName}`);
            }
        }

        // æ‰¹é‡å‹ç¼©å›¾ç‰‡
        function compressBatch() {
            if (files.length === 0) {
                alert('è¯·å…ˆé€‰æ‹©å›¾ç‰‡ï¼');
                return;
            }
            
            // é‡ç½®è¿›åº¦
            updateProgress(0);
            compressedFiles = [];
            totalCompressedSize = 0;
            document.getElementById('successMessage').style.display = 'none';
            
            // å¤„ç†æ¯ä¸ªæ–‡ä»¶
            let processed = 0;
            
            files.forEach((fileData, index) => {
                compressImage(fileData.file).then(compressedData => {
                    // ä¿å­˜å‹ç¼©ç»“æœ
                    const fileName = fileData.newName + '.' + getFileExtension(fileData.file.name);
                    compressedFiles.push({
                        dataUrl: compressedData.dataUrl,
                        name: fileName,
                        originalName: fileData.file.name,
                        size: compressedData.size
                    });
                    
                    // æ›´æ–°æ–‡ä»¶çŠ¶æ€
                    files[index].compressed = true;
                    totalCompressedSize += compressedData.size;
                    
                    // æ›´æ–°è¿›åº¦
                    processed++;
                    updateProgress(Math.round((processed / files.length) * 100));
                    
                    // æ›´æ–°å¤§å°ç»Ÿè®¡
                    updateSizeStats();
                    
                    // å…¨éƒ¨å¤„ç†å®Œæˆ
                    if (processed === files.length) {
                        document.getElementById('downloadAll').style.display = 'block';
                        document.getElementById('successMessage').style.display = 'block';
                        renderFileList();
                    }
                }).catch(error => {
                    console.error('å‹ç¼©é”™è¯¯:', error);
                    alert(`å›¾ç‰‡ ${fileData.name} å‹ç¼©å¤±è´¥: ${error.message}`);
                    processed++;
                    updateProgress(Math.round((processed / files.length) * 100));
                });
            });
        }

        // å‹ç¼©å•ä¸ªå›¾ç‰‡ - ä¿è¯100KBä»¥ä¸‹
        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        try {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            
                            // åˆå§‹è®¾ç½®
                            let targetWidth = img.width;
                            let targetHeight = img.height;
                            let quality = 0.85;
                            let compressedDataUrl;
                            let compressedSizeKB;
                            
                            // æœ€å¤§å°è¯•æ¬¡æ•°
                            let attempts = 0;
                            const maxAttempts = 20;
                            
                            do {
                                // è®¾ç½®ç”»å¸ƒå°ºå¯¸
                                canvas.width = targetWidth;
                                canvas.height = targetHeight;
                                
                                // æ¸…é™¤ç”»å¸ƒ
                                ctx.clearRect(0, 0, canvas.width, canvas.height);
                                
                                // ç»˜åˆ¶å›¾åƒåˆ°ç”»å¸ƒ
                                ctx.drawImage(img, 0, 0, targetWidth, targetHeight);
                                
                                // è·å–å‹ç¼©åçš„æ•°æ®URL
                                compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                                
                                // è®¡ç®—å¤§å°
                                compressedSizeKB = Math.round((compressedDataUrl.length * 3 / 4) / 1024);
                                
                                // è°ƒæ•´å‚æ•°
                                if (compressedSizeKB > maxSizeKB) {
                                    if (quality > 0.5) {
                                        // å…ˆé™ä½è´¨é‡
                                        quality -= 0.1;
                                    } else if (targetWidth > 800 || targetHeight > 800) {
                                        // å¦‚æœå›¾ç‰‡å¾ˆå¤§ï¼ŒæŒ‰æ¯”ä¾‹ç¼©å°
                                        const scale = 0.9;
                                        targetWidth = Math.floor(targetWidth * scale);
                                        targetHeight = Math.floor(targetHeight * scale);
                                    } else {
                                        // æœ€åæ‰‹æ®µï¼šå¤§å¹…é™ä½è´¨é‡
                                        quality -= 0.2;
                                    }
                                }
                                
                                attempts++;
                                if (attempts > maxAttempts) {
                                    throw new Error('å‹ç¼©å°è¯•æ¬¡æ•°è¶…è¿‡é™åˆ¶');
                                }
                                
                            } while (compressedSizeKB > maxSizeKB && quality > 0.1);
                            
                            resolve({
                                dataUrl: compressedDataUrl,
                                size: compressedDataUrl.length * 3 / 4 // è¿‘ä¼¼å¤§å°
                            });
                        } catch (error) {
                            reject(error);
                        }
                    };
                    
                    img.onerror = function() {
                        reject(new Error('å›¾ç‰‡åŠ è½½å¤±è´¥'));
                    };
                    
                    img.src = e.target.result;
                };
                
                reader.onerror = function() {
                    reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'));
                };
                
                reader.readAsDataURL(file);
            });
        }

        // æ›´æ–°è¿›åº¦æ¡
        function updateProgress(percent) {
            document.getElementById('progressText').textContent = percent + '%';
            document.getElementById('progressFill').style.width = percent + '%';
        }
        
        // æ›´æ–°å¤§å°ç»Ÿè®¡
        function updateSizeStats() {
            document.getElementById('originalTotal').textContent = (totalOriginalSize / 1024).toFixed(0) + ' KB';
            
            if (totalCompressedSize > 0) {
                document.getElementById('compressedTotal').textContent = (totalCompressedSize / 1024).toFixed(0) + ' KB';
                const savings = 100 - (totalCompressedSize / totalOriginalSize * 100);
                document.getElementById('savings').textContent = savings.toFixed(0) + '%';
            }
        }

        // æ‰“åŒ…ä¸‹è½½æ‰€æœ‰å›¾ç‰‡
        function downloadAllAsZip() {
            if (compressedFiles.length === 0) {
                alert('è¯·å…ˆå‹ç¼©å›¾ç‰‡ï¼');
                return;
            }
            
            alert('æ­£åœ¨åˆ›å»ºå‹ç¼©åŒ…ï¼Œè¯·ç¨å€™...');
            
            try {
                // åˆ›å»ºZIPæ–‡ä»¶
                const zip = new JSZip();
                
                compressedFiles.forEach(file => {
                    // å°†dataURLè½¬æ¢ä¸ºBlob
                    const blob = dataURLtoBlob(file.dataUrl);
                    zip.file(file.name, blob);
                });
                
                // ç”ŸæˆZIPæ–‡ä»¶å¹¶ä¸‹è½½
                zip.generateAsync({type:"blob"})
                .then(function(content) {
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(content);
                    link.download = "æ–‡æ–‡è€å¸ˆ_å‹ç¼©å›¾ç‰‡åŒ….zip";
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    alert('å‹ç¼©åŒ…ä¸‹è½½å®Œæˆï¼');
                });
            } catch (error) {
                console.error('æ‰“åŒ…é”™è¯¯:', error);
                alert('åˆ›å»ºå‹ç¼©åŒ…å¤±è´¥: ' + error.message);
            }
        }
        
        // å°†dataURLè½¬æ¢ä¸ºBlob
        function dataURLtoBlob(dataurl) {
            const arr = dataurl.split(',');
            const mime = arr[0].match(/:(.*?);/)[1];
            const bstr = atob(arr[1]);
            let n = bstr.length;
            const u8arr = new Uint8Array(n);
            
            while (n--) {
                u8arr[n] = bstr.charCodeAt(n);
            }
            
            return new Blob([u8arr], {type: mime});
        }

        // è·å–æ–‡ä»¶æ‰©å±•å
        function getFileExtension(fileName) {
            return fileName.split('.').pop().toLowerCase();
        }

        // ä¸‹è½½Excelæ¨¡æ¿
        function downloadExcelTemplate() {
            try {
                // åˆ›å»ºç¤ºä¾‹æ•°æ®
                const data = [
                    ['åŸå§‹æ–‡ä»¶å', 'æ–°æ–‡ä»¶å'],
                    ['IMG_001.jpg', 'äº§å“å±•ç¤º-1'],
                    ['IMG_002.png', 'äº§å“å±•ç¤º-2'],
                    ['photo123.jpeg', 'å…¬å¸æ´»åŠ¨']
                ];
                
                // åˆ›å»ºå·¥ä½œç°¿
                const ws = XLSX.utils.aoa_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "é‡å‘½åæ¨¡æ¿");
                
                // ç”ŸæˆExcelæ–‡ä»¶å¹¶ä¸‹è½½
                XLSX.writeFile(wb, "å›¾ç‰‡é‡å‘½åæ¨¡æ¿.xlsx");
            } catch (error) {
                console.error('Excelæ¨¡æ¿é”™è¯¯:', error);
                alert('ç”ŸæˆExcelæ¨¡æ¿å¤±è´¥: ' + error.message);
            }
        }

        // å¤„ç†Excelæ–‡ä»¶
        function handleExcelFile(excelFile) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    
                    // è·å–ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                    
                    // æ£€æŸ¥æ ‡é¢˜è¡Œ
                    if (jsonData.length < 1 || jsonData[0][0] !== 'åŸå§‹æ–‡ä»¶å' || jsonData[0][1] !== 'æ–°æ–‡ä»¶å') {
                        alert('Excelæ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·ä½¿ç”¨ä¸‹è½½çš„æ¨¡æ¿æ ¼å¼');
                        return;
                    }
                    
                    // åˆ›å»ºæ–‡ä»¶åæ˜ å°„
                    const nameMap = {};
                    for (let i = 1; i < jsonData.length; i++) {
                        if (jsonData[i].length >= 2 && jsonData[i][0] && jsonData[i][1]) {
                            nameMap[jsonData[i][0]] = jsonData[i][1];
                        }
                    }
                    
                    // åº”ç”¨é‡å‘½å
                    files.forEach((fileData, index) => {
                        if (nameMap[fileData.name]) {
                            fileData.newName = nameMap[fileData.name];
                        }
                    });
                    
                    // æ›´æ–°UI
                    renderFileList();
                    alert('é‡å‘½åè§„åˆ™å·²åº”ç”¨ï¼');
                } catch (error) {
                    console.error('Excelå¤„ç†é”™è¯¯:', error);
                    alert('å¤„ç†Excelæ–‡ä»¶å¤±è´¥: ' + error.message);
                }
            };
            
            reader.onerror = function() {
                alert('è¯»å–Excelæ–‡ä»¶å¤±è´¥');
            };
            
            reader.readAsArrayBuffer(excelFile);
        }
    </script>
</body>
</html>